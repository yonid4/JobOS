{% extends "base.html" %}

{% block title %}Job Opportunities - Application Tracker{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Sidebar Filters -->
        <div class="col-md-3 col-lg-2">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-filter"></i> Filters
                    </h5>
                </div>
                <div class="card-body">
                    <form id="filterForm" method="GET">
                        <!-- Company Filter -->
                        <div class="mb-3">
                            <label for="company" class="form-label">Company</label>
                            <input type="text" class="form-control" id="company" name="company" 
                                   value="{{ filters.company }}" placeholder="Search companies...">
                        </div>
                        
                        <!-- Location Filter -->
                        <div class="mb-3">
                            <label for="location" class="form-label">Location</label>
                            <input type="text" class="form-control" id="location" name="location" 
                                   value="{{ filters.location }}" placeholder="City, State...">
                        </div>
                        
                        <!-- Status Filter -->
                        <div class="mb-3">
                            <label for="status" class="form-label">Application Status</label>
                            <select class="form-select" id="status" name="status">
                                <option value="">All Statuses</option>
                                <option value="not_applied" {% if filters.status == 'not_applied' %}selected{% endif %}>Not Applied</option>
                                <option value="applied" {% if filters.status == 'applied' %}selected{% endif %}>Applied</option>
                                <option value="interviewing" {% if filters.status == 'interviewing' %}selected{% endif %}>Interviewing</option>
                                <option value="offered" {% if filters.status == 'offered' %}selected{% endif %}>Offered</option>
                                <option value="rejected" {% if filters.status == 'rejected' %}selected{% endif %}>Rejected</option>
                            </select>
                        </div>
                        
                        <!-- Salary Range -->
                        <div class="mb-3">
                            <label class="form-label">Salary Range</label>
                            <div class="row">
                                <div class="col-6">
                                    <input type="number" class="form-control" id="salary_min" name="salary_min" 
                                           value="{{ filters.salary_min }}" placeholder="Min">
                                </div>
                                <div class="col-6">
                                    <input type="number" class="form-control" id="salary_max" name="salary_max" 
                                           value="{{ filters.salary_max }}" placeholder="Max">
                                </div>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-search"></i> Apply Filters
                        </button>
                        
                        <button type="button" class="btn btn-outline-secondary w-100 mt-2" onclick="clearFilters()">
                            <i class="fas fa-times"></i> Clear Filters
                        </button>
                    </form>
                </div>
            </div>
            
            <!-- Analytics Card -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-bar"></i> Analytics (30 days)
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6">
                            <h4 class="text-primary">{{ analytics.total_applications or 0 }}</h4>
                            <small class="text-muted">Applications</small>
                        </div>
                        <div class="col-6">
                            <h4 class="text-success">{{ "%.1f"|format(analytics.response_rate or 0) }}%</h4>
                            <small class="text-muted">Response Rate</small>
                        </div>
                    </div>
                    <hr>
                    <div class="row text-center">
                        <div class="col-6">
                            <h4 class="text-info">{{ analytics.responses_received or 0 }}</h4>
                            <small class="text-muted">Responses</small>
                        </div>
                        <div class="col-6">
                            <h4 class="text-warning">{{ analytics.status_counts.get('interviewing', 0) }}</h4>
                            <small class="text-muted">Interviews</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="col-md-9 col-lg-10">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-0">Job Opportunities</h1>
                    <p class="text-muted mb-0">{{ jobs|length }} jobs found</p>
                </div>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary active" onclick="toggleView('card')">
                        <i class="fas fa-th-large"></i> Cards
                    </button>
                    <button type="button" class="btn btn-outline-primary" onclick="toggleView('list')">
                        <i class="fas fa-list"></i> List
                    </button>
                </div>
            </div>
            
            <!-- Job Results -->
            <div id="jobResults">
                {% if jobs %}
                    <div class="row" id="jobCards">
                        {% for job in jobs %}
                        <div class="col-lg-6 col-xl-4 mb-4">
                            <div class="card job-card h-100" data-job-id="{{ job.job_id }}">
                                <div class="card-header d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <h5 class="card-title mb-1">
                                            <a href="{{ url_for('job_detail', job_id=job.job_id) }}" class="text-decoration-none">
                                                {{ job.job_title }}
                                            </a>
                                        </h5>
                                        <h6 class="text-muted mb-0">{{ job.company_name }}</h6>
                                    </div>
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" 
                                                data-bs-toggle="dropdown">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item" href="{{ job.job_url }}" target="_blank">
                                                <i class="fas fa-external-link-alt"></i> View Original
                                            </a></li>
                                            <li><a class="dropdown-item" href="#" onclick="toggleFavorite('{{ job.job_id }}')">
                                                <i class="fas fa-star {% if job.is_favorited %}text-warning{% endif %}"></i> 
                                                {% if job.is_favorited %}Remove from{% else %}Add to{% endif %} Favorites
                                            </a></li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li><a class="dropdown-item" href="#" onclick="markAsApplied('{{ job.job_id }}')">
                                                <i class="fas fa-check"></i> Mark as Applied
                                            </a></li>
                                        </ul>
                                    </div>
                                </div>
                                
                                <div class="card-body">
                                    <!-- Location and Salary -->
                                    <div class="mb-3">
                                        <div class="d-flex align-items-center mb-1">
                                            <i class="fas fa-map-marker-alt text-muted me-2"></i>
                                            <span class="text-muted">{{ job.location or 'Location not specified' }}</span>
                                        </div>
                                        {% if job.salary_range %}
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-dollar-sign text-muted me-2"></i>
                                            <span class="text-muted">{{ job.salary_range }}</span>
                                        </div>
                                        {% endif %}
                                    </div>
                                    
                                    <!-- Job Description Preview -->
                                    <p class="card-text text-muted small">
                                        {{ job.job_description[:150] if job.job_description else 'No description available' }}{% if job.job_description and job.job_description|length > 150 %}...{% endif %}
                                    </p>
                                    
                                    <!-- Tags -->
                                    <div class="mb-3">
                                        {% if job.job_type %}
                                        <span class="badge bg-primary me-1">{{ job.job_type|title }}</span>
                                        {% endif %}
                                        {% if job.experience_level %}
                                        <span class="badge bg-info me-1">{{ job.experience_level|title }}</span>
                                        {% endif %}
                                        {% if job.work_arrangement %}
                                        <span class="badge bg-success me-1">{{ job.work_arrangement|title }}</span>
                                        {% endif %}
                                    </div>
                                    
                                    <!-- Application Status -->
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            {% if job.application_status %}
                                                <span class="badge bg-{{ get_status_color(job.application_status) }}">
                                                    {{ job.application_status|title }}
                                                </span>
                                                <small class="text-muted d-block">
                                                    Applied: {{ job.applied_date.strftime('%m/%d/%Y') if job.applied_date else 'Unknown' }}
                                                </small>
                                            {% else %}
                                                <span class="badge bg-secondary">Not Applied</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="card-footer">
                                    <div class="row">
                                        <div class="col-6">
                                            <button type="button" class="btn btn-outline-primary btn-sm w-100" 
                                                    onclick="markAsApplied('{{ job.job_id }}')">
                                                <i class="fas fa-check"></i> Apply
                                            </button>
                                        </div>
                                        <div class="col-6">
                                            <button type="button" class="btn btn-outline-secondary btn-sm w-100" 
                                                    onclick="toggleFavorite('{{ job.job_id }}')">
                                                <i class="fas fa-star {% if job.is_favorited %}text-warning{% endif %}"></i> 
                                                {% if job.is_favorited %}Favorited{% else %}Favorite{% endif %}
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <!-- Pagination -->
                    <nav aria-label="Job results pagination">
                        <ul class="pagination justify-content-center">
                            {% if page > 1 %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('jobs_page', page=page-1, **filters) }}">Previous</a>
                            </li>
                            {% endif %}
                            <li class="page-item active">
                                <span class="page-link">{{ page }}</span>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('jobs_page', page=page+1, **filters) }}">Next</a>
                            </li>
                        </ul>
                    </nav>
                    
                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-search fa-3x text-muted mb-3"></i>
                        <h4 class="text-muted">No jobs found</h4>
                        <p class="text-muted">Try adjusting your filters or search for new opportunities.</p>
                        <a href="{{ url_for('search') }}" class="btn btn-primary">
                            <i class="fas fa-search"></i> Search for Jobs
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Apply to Job Modal -->
<div class="modal fade" id="applyModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Mark as Applied</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="applyForm">
                    <input type="hidden" id="applyJobId">
                    <div class="mb-3">
                        <label for="applicationMethod" class="form-label">Application Method</label>
                        <select class="form-select" id="applicationMethod" name="application_method" required>
                            <option value="manual">Manual Application</option>
                            <option value="automated">Automated Application</option>
                            <option value="linkedin_easy_apply">LinkedIn Easy Apply</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="applicationNotes" class="form-label">Notes (Optional)</label>
                        <textarea class="form-control" id="applicationNotes" name="notes" rows="3" 
                                  placeholder="Add any notes about this application..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitApplication()">Mark as Applied</button>
            </div>
        </div>
    </div>
</div>

<!-- Performance indicator -->
<div id="performanceIndicator" class="position-fixed bottom-0 end-0 m-3" style="display: none;">
    <div class="alert alert-info alert-dismissible fade show" role="alert">
        <small>
            <i class="fas fa-clock"></i> 
            <span id="loadTime">Loading...</span>
        </small>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
</div>

<script>
// Optimized JavaScript for better performance
document.addEventListener('DOMContentLoaded', function() {
    // Show performance indicator
    const startTime = performance.now();
    
    // Hide performance indicator after page load
    window.addEventListener('load', function() {
        const loadTime = performance.now() - startTime;
        document.getElementById('loadTime').textContent = `Page loaded in ${loadTime.toFixed(0)}ms`;
        document.getElementById('performanceIndicator').style.display = 'block';
        
        // Hide after 3 seconds
        setTimeout(() => {
            document.getElementById('performanceIndicator').style.display = 'none';
        }, 3000);
    });
    
    // Optimized filter form handling
    const filterForm = document.getElementById('filterForm');
    if (filterForm) {
        // Debounce filter changes
        let filterTimeout;
        const filterInputs = filterForm.querySelectorAll('input, select');
        
        filterInputs.forEach(input => {
            input.addEventListener('change', function() {
                clearTimeout(filterTimeout);
                filterTimeout = setTimeout(() => {
                    filterForm.submit();
                }, 500); // 500ms debounce
            });
        });
    }
});

// Optimized functions
function clearFilters() {
    const form = document.getElementById('filterForm');
    form.reset();
    form.submit();
}

function toggleView(viewType) {
    const cards = document.getElementById('jobCards');
    const buttons = document.querySelectorAll('.btn-group .btn');
    
    buttons.forEach(btn => btn.classList.remove('active'));
    event.target.closest('.btn').classList.add('active');
    
    if (viewType === 'list') {
        cards.classList.remove('row');
        cards.classList.add('list-group');
        cards.querySelectorAll('.col-lg-6').forEach(col => {
            col.classList.remove('col-lg-6', 'col-xl-4', 'mb-4');
            col.classList.add('list-group-item');
        });
    } else {
        cards.classList.remove('list-group');
        cards.classList.add('row');
        cards.querySelectorAll('.list-group-item').forEach(item => {
            item.classList.remove('list-group-item');
            item.classList.add('col-lg-6', 'col-xl-4', 'mb-4');
        });
    }
}

function markAsApplied(jobId) {
    document.getElementById('applyJobId').value = jobId;
    new bootstrap.Modal(document.getElementById('applyModal')).show();
}

function submitApplication() {
    const jobId = document.getElementById('applyJobId').value;
    const method = document.getElementById('applicationMethod').value;
    const notes = document.getElementById('applicationNotes').value;
    
    fetch('/api/jobs/apply', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            job_id: jobId,
            application_method: method,
            notes: notes
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update UI without page reload
            const jobCard = document.querySelector(`[data-job-id="${jobId}"]`);
            if (jobCard) {
                const statusBadge = jobCard.querySelector('.badge');
                if (statusBadge) {
                    statusBadge.className = 'badge bg-success';
                    statusBadge.textContent = 'Applied';
                }
            }
            bootstrap.Modal.getInstance(document.getElementById('applyModal')).hide();
            showToast('Application marked successfully!', 'success');
        } else {
            showToast('Error marking application: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error marking application', 'error');
    });
}

function toggleFavorite(jobId) {
    fetch('/api/jobs/favorite', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            job_id: jobId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update UI without page reload
            const jobCard = document.querySelector(`[data-job-id="${jobId}"]`);
            if (jobCard) {
                const starIcons = jobCard.querySelectorAll('.fa-star');
                starIcons.forEach(icon => {
                    icon.classList.toggle('text-warning');
                });
                
                const favoriteBtn = jobCard.querySelector('.btn-outline-secondary');
                if (favoriteBtn) {
                    const icon = favoriteBtn.querySelector('.fa-star');
                    if (icon.classList.contains('text-warning')) {
                        favoriteBtn.innerHTML = '<i class="fas fa-star text-warning"></i> Favorited';
                    } else {
                        favoriteBtn.innerHTML = '<i class="fas fa-star"></i> Favorite';
                    }
                }
            }
            showToast(data.favorited ? 'Added to favorites!' : 'Removed from favorites!', 'success');
        } else {
            showToast('Error updating favorite: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error updating favorite', 'error');
    });
}

function showToast(message, type = 'info') {
    // Simple toast notification
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(toast);
    
    // Auto-remove after 3 seconds
    setTimeout(() => {
        if (toast.parentNode) {
            toast.remove();
        }
    }, 3000);
}
</script>

<style>
/* Optimized CSS for better performance */
.job-card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.job-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

/* Reduce animations for better performance */
@media (prefers-reduced-motion: reduce) {
    .job-card {
        transition: none;
    }
    
    .job-card:hover {
        transform: none;
    }
}

/* Optimize for mobile */
@media (max-width: 768px) {
    .col-lg-6.col-xl-4 {
        flex: 0 0 100%;
        max-width: 100%;
    }
}

/* Performance optimizations */
.card {
    contain: layout style paint;
}

.job-card .card-body {
    contain: layout style;
}
</style>
{% endblock %} 
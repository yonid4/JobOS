{% extends "base.html" %}

{% block title %}Settings - Job Qualification System{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="h2 mb-1">System Settings</h1>
                <p class="text-muted mb-0">Configure general settings</p>
            </div>
            <div class="text-end">
                <button type="button" class="btn btn-primary" onclick="saveSettings()">
                    <i class="fas fa-save me-1"></i> Save Settings
                </button>
                <a href="{{ url_for('auth.logout') }}" class="btn btn-outline-danger ms-2">
                    <i class="fas fa-sign-out-alt me-1"></i> Logout
                </a>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <form id="settings-form" method="POST" action="{{ url_for('update_settings') }}">

            <!-- AI Score Threshold Section -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-brain me-2"></i>
                        AI Score Threshold
                    </h5>
                </div>
                <div class="card-body">
                    <p class="section-description">
                        Set the minimum AI score threshold for jobs to appear in your job tracker. Only jobs with scores equal to or above this threshold will be displayed.
                    </p>
                    
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <label for="score-threshold" class="form-label">Minimum Score: <span id="threshold-value">70</span>%</label>
                            <input type="range" class="form-range" id="score-threshold" name="score_threshold" 
                                   min="1" max="100" value="70" oninput="updateThresholdValue(this.value)">
                            <div class="d-flex justify-content-between small text-muted">
                                <span>1% (Show All)</span>
                                <span>50% (Average)</span>
                                <span>100% (Perfect Match)</span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="threshold-indicator">
                                <div class="badge bg-primary p-3" style="cursor: pointer;" onclick="editThreshold()" title="Click to edit directly">
                                    <i class="fas fa-target me-1"></i>
                                    <span id="threshold-badge">70</span>%
                                </div>
                                <div class="mt-2">
                                    <small class="text-muted">Current threshold</small>
                                    <br>
                                    <small class="text-muted" style="font-size: 0.75rem;">
                                        <i class="fas fa-hand-pointer me-1"></i>Click to edit
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <small class="text-muted">
                            <strong>Tip:</strong> Lower values show more jobs but may include less relevant matches. Higher values show fewer but more qualified jobs.
                        </small>
                    </div>
                </div>
            </div>

            <!-- Resume Upload Section -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-file-alt me-2"></i>
                        Resume Information
                    </h5>
                </div>
                <div class="card-body">
                    <p class="section-description">
                        Upload your resume for better job matching. It will be processed automatically when you search for jobs.
                    </p>
                    
                    <div class="resume-upload-area mb-3">
                        <input type="file" id="resume-upload" accept=".pdf,.docx" style="display: none;">
                        <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('resume-upload').click()">
                            <i class="fas fa-upload me-1"></i> Choose Resume File
                        </button>
                        <span id="selected-file" class="ms-2 text-muted">No file selected</span>
                        <button type="button" id="upload-btn" class="btn btn-primary ms-2" onclick="uploadResume()" disabled>
                            <i class="fas fa-upload me-1"></i> Upload Resume
                        </button>
                    </div>
                    
                    <div id="resume-status" class="resume-status">
                        <!-- Will be populated with current resume status -->
                    </div>
                    
                    <div class="file-requirements">
                        <small class="text-muted">
                            <strong>Supported formats:</strong> PDF, DOCX<br>
                            <strong>Max file size:</strong> 10MB<br>
                            <strong>Processing:</strong> Your resume will be processed when you search for jobs
                        </small>
                    </div>
                </div>
            </div>


        </form>
    </div>

    <div class="col-lg-4">
        <!-- Current Status -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    Current Status
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <h6>Resume Status</h6>
                    <div id="resume-status-summary">
                        <p class="text-muted mb-0">
                            <i class="fas fa-spinner fa-spin me-1"></i>Loading...
                        </p>
                    </div>
                </div>
                

                
                <div>
                    <h6>System Status</h6>
                    <p class="text-success mb-0">
                        <i class="fas fa-check-circle me-1"></i>System ready
                    </p>
                </div>
            </div>
        </div>

        <!-- Help -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-question-circle me-2"></i>
                    Help & Support
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <h6>Getting Started</h6>
                    <ul class="list-unstyled small">
                        <li class="mb-1">
                            <a href="https://console.cloud.google.com/" target="_blank">
                                Google Cloud Console
                            </a>
                        </li>
                        <li class="mb-1">
                            <a href="https://developers.google.com/sheets/api" target="_blank">
                                Google Sheets API Docs
                            </a>
                        </li>
                    </ul>
                </div>
                
                <div>
                    <h6>Features</h6>
                    <ul class="list-unstyled small mb-0">
                        <li class="mb-1">
                            <i class="fas fa-check text-success me-1"></i>LinkedIn job extraction
                        </li>
                        <li class="mb-1">
                            <i class="fas fa-check text-success me-1"></i>Google Sheets integration
                        </li>
                        <li class="mb-1">
                            <i class="fas fa-check text-success me-1"></i>Job qualification analysis
                        </li>
                        <li class="mb-1">
                            <i class="fas fa-check text-success me-1"></i>Advanced filtering options
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function updateThresholdValue(value) {
    document.getElementById('threshold-value').textContent = value;
    document.getElementById('threshold-badge').textContent = value;
    
    // Update badge color based on threshold level
    const badge = document.querySelector('.threshold-indicator .badge');
    badge.className = 'badge p-3 ' + getThresholdBadgeColor(value) + ' ' + (badge.onclick ? 'cursor-pointer' : '');
    badge.style.cursor = 'pointer';
}

function getThresholdBadgeColor(value) {
    if (value >= 90) return 'bg-success';
    if (value >= 70) return 'bg-primary';
    if (value >= 50) return 'bg-warning';
    return 'bg-secondary';
}

function editThreshold() {
    const badgeElement = document.querySelector('.threshold-indicator .badge');
    const currentValue = document.getElementById('threshold-badge').textContent;
    
    // Create input field
    const inputHtml = `
        <i class="fas fa-target me-1"></i>
        <input type="number" id="threshold-input" value="${currentValue}" 
               min="1" max="100" style="width: 60px; background: transparent; border: 1px solid rgba(255,255,255,0.3); color: white; text-align: center; border-radius: 4px;" 
               onkeyup="handleThresholdKeyup(event)" onblur="saveThresholdEdit()" onfocus="this.select()">%
    `;
    
    // Replace badge content with input
    badgeElement.innerHTML = inputHtml;
    badgeElement.onclick = null; // Remove click handler while editing
    
    // Focus the input
    const input = document.getElementById('threshold-input');
    input.focus();
    input.select();
}

function handleThresholdKeyup(event) {
    if (event.key === 'Enter') {
        saveThresholdEdit();
    } else if (event.key === 'Escape') {
        cancelThresholdEdit();
    }
}

function saveThresholdEdit() {
    const input = document.getElementById('threshold-input');
    if (!input) return;
    
    let newValue = parseInt(input.value);
    
    // Validate input
    if (isNaN(newValue) || newValue < 1 || newValue > 100) {
        // If invalid, revert to current slider value
        newValue = parseInt(document.getElementById('score-threshold').value);
    }
    
    // Update both slider and display
    document.getElementById('score-threshold').value = newValue;
    updateThresholdValue(newValue);
    
    // Restore badge display
    restoreBadgeDisplay(newValue);
}

function cancelThresholdEdit() {
    const currentValue = document.getElementById('score-threshold').value;
    restoreBadgeDisplay(currentValue);
}

function restoreBadgeDisplay(value) {
    const badgeElement = document.querySelector('.threshold-indicator .badge');
    
    // Restore original badge content
    badgeElement.innerHTML = `
        <i class="fas fa-target me-1"></i>
        <span id="threshold-badge">${value}</span>%
    `;
    
    // Restore click handler
    badgeElement.onclick = editThreshold;
    badgeElement.style.cursor = 'pointer';
    badgeElement.title = 'Click to edit directly';
}

function saveSettings() {
    const submitBtn = $('button[onclick="saveSettings()"]');
    
    // Show loading state
    submitBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i> Saving...');
    
    // Get current threshold value
    const scoreThreshold = parseInt(document.getElementById('score-threshold').value);
    
    // Save settings via API
    fetch('/api/user-settings', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            score_threshold: scoreThreshold
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Settings saved successfully!', 'success');
        } else {
            showAlert('Error: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error saving settings:', error);
        showAlert('Error saving settings: ' + error, 'error');
    })
    .finally(() => {
        // Restore button state
        submitBtn.prop('disabled', false).html('<i class="fas fa-save me-1"></i> Save Settings');
    });
}

// Helper function to show alerts
function showAlert(message, type) {
    // Create alert element
    const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
    const iconClass = type === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-triangle';
    
    const alertHtml = `
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
            <i class="${iconClass} me-2"></i>${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    `;
    
    // Insert at top of page
    const container = document.querySelector('.row .col-lg-8');
    if (container) {
        container.insertAdjacentHTML('afterbegin', alertHtml);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            const alert = container.querySelector('.alert');
            if (alert) {
                alert.remove();
            }
        }, 5000);
    }
}

function uploadResume() {
    const fileInput = document.getElementById('resume-upload');
    const file = fileInput.files[0];
    
    if (!file) {
        showAlert('Please select a file first', 'warning');
        return;
    }
    
    console.log('Uploading file:', file.name, 'Size:', file.size, 'Type:', file.type);
    
    const formData = new FormData();
    formData.append('resume', file);
    
    // Debug: Log FormData contents
    for (let [key, value] of formData.entries()) {
        console.log('FormData entry:', key, value);
    }
    
    // Show upload progress
    const uploadBtn = document.getElementById('upload-btn');
    uploadBtn.textContent = 'Uploading...';
    uploadBtn.disabled = true;
    
    fetch('/resume/upload', {
        method: 'POST',
        body: formData,
        // Don't set Content-Type header - let the browser set it automatically for FormData
        // This ensures the correct multipart/form-data boundary is set
        // Cache bust: 2025-07-31
    })
    .then(response => {
        console.log('Response status:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('Response data:', data);
        if (data.success) {
            showAlert(data.message, 'success');
            loadResumeStatus(); // Refresh status display
        } else {
            showAlert('Error: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Upload error:', error);
        showAlert('Upload failed: ' + error, 'error');
    })
    .finally(() => {
        uploadBtn.textContent = 'Upload Resume';
        uploadBtn.disabled = false;
        fileInput.value = ''; // Clear file input
        document.getElementById('selected-file').textContent = 'No file selected';
    });
}

function loadResumeStatus() {
    fetch('/resume/status')
    .then(response => response.json())
    .then(data => {
        const statusDiv = document.getElementById('resume-status');
        const summaryDiv = document.getElementById('resume-status-summary');
        
        // Handle the response structure from Flask app
        const resumeData = data.status || data;
        
        if (resumeData.has_resume) {
            summaryDiv.innerHTML = `
                <p class="text-success mb-1">
                    <i class="fas fa-check-circle me-1"></i>Resume uploaded
                </p>
                <p class="text-muted small mb-0">${resumeData.filename}</p>
            `;
            
            statusDiv.innerHTML = `
                <div class="alert alert-info">
                    <h6><i class="fas fa-info-circle me-2"></i>Resume Details</h6>
                    <p class="mb-1"><strong>File:</strong> ${resumeData.filename}</p>
                    <p class="mb-1"><strong>Type:</strong> ${resumeData.file_type.toUpperCase()}</p>
                    <p class="mb-1"><strong>Size:</strong> ${(resumeData.file_size / 1024).toFixed(1)} KB</p>
                    <p class="mb-1"><strong>Uploaded:</strong> ${new Date(resumeData.uploaded_at).toLocaleDateString()}</p>
                    
                    <!-- ${resumeData.is_processed ?
                        `<p class="mb-1 text-success"><strong>Status:</strong> Processed</p>` :
                        `<p class="mb-1 text-warning"><strong>Status:</strong> Will be processed when you search for jobs</p>`
                    } -->
                </div>
            `;
        } else {
            summaryDiv.innerHTML = `
                <p class="text-warning mb-0">
                    <i class="fas fa-exclamation-triangle me-1"></i>No resume uploaded
                </p>
            `;
            
            statusDiv.innerHTML = `
                <div class="alert alert-warning">
                    <h6><i class="fas fa-info-circle me-2"></i>No Resume</h6>
                    <p class="mb-0">Upload a resume to get better job matching results.</p>
                </div>
            `;
        }
    })
    .catch(error => {
        console.error('Error loading resume status:', error);
        document.getElementById('resume-status-summary').innerHTML = `
            <p class="text-danger mb-0">
                <i class="fas fa-exclamation-triangle me-1"></i>Error loading status
            </p>
        `;
    });
}

// Enable upload button when file is selected
document.getElementById('resume-upload').addEventListener('change', function() {
    const fileName = this.files[0] ? this.files[0].name : 'No file selected';
    document.getElementById('selected-file').textContent = fileName;
    document.getElementById('upload-btn').disabled = !this.files[0];
});

// Load current settings when page loads
function loadCurrentSettings() {
    fetch('/api/user-settings')
    .then(response => response.json())
    .then(data => {
        if (data.score_threshold) {
            const threshold = data.score_threshold;
            document.getElementById('score-threshold').value = threshold;
            updateThresholdValue(threshold);
        }
    })
    .catch(error => {
        console.log('Using default threshold value');
        // Keep default value of 70
    });
}

// Load resume status when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadResumeStatus();
    loadCurrentSettings();
});
</script>
{% endblock %} 